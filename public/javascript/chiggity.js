// Generated by CoffeeScript 1.6.3
(function() {
  var loadLocations, map;

  map = null;

  loadLocations = function(bounds) {
    var e, n, s, url, w;
    n = bounds.getNorth();
    e = bounds.getEast();
    s = bounds.getSouth();
    w = bounds.getWest();
    url = "/api/locations?box=" + w + "," + s + "," + e + "," + n;
    return $.ajax({
      url: url,
      dataType: "json",
      success: function(data, textStatus, jqXHR) {
        return console.log(data);
      }
    });
  };

  $(document).ready(function() {
    var attrib, layer, self, subs, url;
    if ($('#map').length) {
      url = 'http://{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png';
      subs = ['otile1', 'otile2', 'otile3', 'otile4'];
      attrib = 'Data, imagery and map information provided by\n<a href="http://open.mapquest.co.uk" target="_blank">MapQuest</a>,\n<a href="http://www.openstreetmap.org/" target="_blank">OpenStreetMap</a> and contributors.';
      map = L.map('map');
      layer = L.tileLayer(url, {
        attribution: attrib,
        maxZoom: 18,
        subdomains: subs
      });
      layer.addTo(map);
      self = null;
      map.on('locationfound', function(levent) {
        var bounds, latlng;
        latlng = levent.latlng;
        if (self) {
          self.setLatLng(latlng);
          self.update();
        } else {
          self = L.marker(latlng);
          self.addTo(map);
        }
        bounds = map.getBounds();
        loadLocations(bounds);
        return false;
      });
      return map.locate({
        setView: true,
        watch: true,
        maxZoom: 16
      });
    }
  });

}).call(this);
